
# Portal Flow

**<ins> Connectivity </ins>**

The DDP services are accessed through the public Internet. DDP accepts communication only via the HTTPS channel.  Custom HTTP headers are also used carry additional information in each request. 

| Environment 		| Host 							 | Base Path |
| ----------------	| ----------------------		 | --------- |
| Integration Test	| https://int.api.firstdata.com  | /ddp		 |
| Pre-Production	| https://cat.api.firstdata.com  | /ddp		 |
| Production		| https://prod.api.firstdata.com | /ddp		 |

**<ins> Header Description </ins>**

The header of Each API call will contain several parameters. It is important that each parameter contain the specified values to have a successful API Call. Any changes to the values will be noted through out the guide.

**<ins> HTTP Headers </ins>**

| Header Name | Required | Description |
| --- | --- | --- |
| Api-Key | Yes | Merchant API key |
| Timestamp | Yes | Request initiation UTC timestamp, formatted as Epoch time. The value is in milliseconds. Sample value format is 1499961987232 |
| Authorization | Yes | Authorization header is required to have the "HMAC" string capitalized and followed by one space followed by the calculated hmac signature. For request generated through Server: Authorization: - HMAC <signature>.   "HMAC " followed by the Encrypted payload as signature, shown below  |
| Client-Request-Id | Yes | Contains a unique ID generated by the client that is used for enforcing idempotency on POST actions. |
| Content-Type | Yes | application/json |
| access\_token | Conditionally | Required when vaulting payment information. Utilizes the tokenId returned from the /tokens api. |


**<ins> Sample Header </ins>**

```JSON
"Content-Type":"application/json"
"Client-Request-Id":"4da61bfb-6852-4f2a-9462-733276f633d7"
"Api-Key": "YMgw8VSrYMG6WTIUnoUUGv7hF9Aqh3EO"
"Authorization" : "HMAC W5X9NAlPgSNsfQX55fXbXrk3arzL6KxcCTA6SrnxL+U="
"Timestamp": "1607368688646"
```

**<ins> How to generate HMAC Signature </ins>**

**<ins> Description </ins>**

HMAC signature is used in all calls made to our API and is necessary to receive a successful response from the system.

**<ins> High Level Flow </ins>**

- Get and save the current time
- Identify and save the request method
- Take the environment key and append a colon along with the current time
- Save this as the current raw signature (key:time)
- Get and save the payload from the request
- If the request method is not POST, move directly to step 7.
- Encrypt the request payload using SHA256 and save it
- Take this encrypted payload, make it a string and then encrypt it using Base64.
- Take the raw signature from step 4, append a colon and the Base64 encrypted payload to it and save it.
- Take the raw signature and HMAC encrypt it using SHA256 against the environment secret.
- Finally take this encrypted raw signature, make it a string and then encrypt it using Base64 to produce the signature for the header.

```javaScript

var key = postman.getEnvironmentVariable('clientKey');
var secret = postman.getEnvironmentVariable('clientSecret');
var time = new Date().getTime();
var method = request.method;
var rawSignature = key + ":" + time;
var requestBody = request.data;

if (method != 'GET' && method != 'DELETE') {
    var payload_digest = CryptoJS.SHA256(requestBody);
    var b64BodyContent = CryptoJS.enc.Base64.stringify(payload_digest);
    rawSignature = rawSignature + ":" + b64BodyContent;
}

var signature = CryptoJS.HmacSHA256(rawSignature, secret);
postman.setEnvironmentVariable('time', time);
postman.setEnvironmentVariable('signature', CryptoJS.enc.Base64.stringify(signature));

```

Digital Disbursement clients are allowed to determine if the recipient should be allowed to register on the recipient portal or not.  Typically, the decision is based on the number of times that a consumer/business is expected to receive a payment. 

DDP allow two types of recipient flow.

• Guest

• Register

**<ins> Guest </ins>**

If the payment is a one-time event, then the guest option is used.  

**<ins> Register </ins>**

If more than one payment is expected to be sent to the recipient, then registration is requested.

**<ins> Multiple Recipient Payments  </ins>**

Recipients determine who will receive the funds:   If this option is being used, then the first recipient to enter his/her disbursement information will receive all of the funds.  The remaining recipients will have to approve the disbursement to the recipient receiving the funds prior to the completion of the disbursement.  If the payment expires before all recipients have approved or a recipient rejects the payment, then the payment is cancelled, funds are released in the DFA, and recipients are notified of the expiration.

DDP Merchant can initiate the below type of payment Initiation for recipient.

## Initiate Single Consumer Payment

Objective Merchant will want to initiate a payment for a single consumer recipient through the merchant portal and send email to recipient for the payment disbursement.

[![Try it out](../../../../assets/images/button.png)](../api/?type=post&path=/ddp/v1/payments)

## Initiate Single Company Payment

Objective Merchant will want to initiate a payment for a single company recipient through the merchant portal and send email to recipient for the payment disbursement.

[![Try it out](../../../../assets/images/button.png)](../api/?type=post&path=/ddp/v1/payments)

## Initiate Multi Consumer Payment

Objective Merchant will want to initiate a payment for a Multi consumer recipient through the merchant portal and send email to recipient for the payment disbursement.

[![Try it out](../../../../assets/images/button.png)](../api/?type=post&path=/ddp/v1/payments)

## Initiate Multi Company Payment

Objective Merchant will want to initiate a payment for a Multi company recipient through the merchant portal and send email to recipient for the payment disbursement.

[![Try it out](../../../../assets/images/button.png)](../api/?type=post&path=/ddp/v1/payments)

## Cancel

**<ins> Description </ins>**

Merchant can only cancel payments that are in a “Pending” status. Once a disbursement method has been selected by the recipient, the payment is no longer able to be cancelled. After disbursement cancellation only applicable to ACH, Coinbase, E-check, Venmo and PayPal.

Clients are able to initiate a payment cancellation at any time during the process, unless the disbursement is being processed. When a cancellation is successful:

• The Transaction and Payment statuses are updated.

• The hold is removed from the funds in the DFA.

• Notification is sent to the recipient(s).

[![Try it out](../../../../assets/images/button.png)](../api/?type=patch&path=/ddp/v1/payments/{id}/cancel)

**<ins> Description </ins>**

## Get Merchant Info

This request will get the details of the onboarded merchant with no request parameter only the headers are required. With this call you can get the full information of the merchant like ledger balance, Available balance, DFA Account Number, Merchant Name & Address details etc.

[![Try it out](../../../../assets/images/button.png)](../api/?type=get&path=/ddp/v1/merchantInfo)

## See Also

- [Please refer our FAQ's](?path=docs/faq/faq.md&branch=develop#portal-flow-faqs)